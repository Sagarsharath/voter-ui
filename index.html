<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Voter Data</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-3">

<h5>Voter Search</h5>

<div class="row g-2 mb-3">
  <div class="col"><input id="voterId" class="form-control" placeholder="Voter ID"></div>
  <div class="col"><input id="firstName" class="form-control" placeholder="First Name"></div>
  <div class="col"><input id="lastName" class="form-control" placeholder="Last Name"></div>
  <div class="col"><input id="fatherName" class="form-control" placeholder="Father Name"></div>
  <div class="col"><input id="caste" class="form-control" placeholder="Caste"></div>
</div>

<button class="btn btn-primary mb-3" onclick="applySearch()">Search</button>

<table class="table table-bordered table-sm">
  <thead>
    <tr>
      <th>Voter ID</th>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Caste</th>
      <th>Father Name</th>
      <th>View</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<!-- MODAL -->
<div class="modal fade" id="detailModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Voter Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="details"></div>
        <hr>
        <label>Contact Number</label>
        <input id="contactInput" class="form-control">
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="save()">Update</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwX9qI1RE_M1zjq7c4BMfqCxasnl3ENpGjP2Rlm2vQpqKfiV2QzciRH7pMSqn_qDGLDAQ/exec";
let allData = [];
let selected = null;

fetch(API_URL).then(r => r.json()).then(d => {
  allData = d;
  render(d);
});

function applySearch() {
  let f = {
    voterId: voterId.value,
    firstName: firstName.value,
    lastName: lastName.value,
    fatherName: fatherName.value,
    caste: caste.value
  };

  let filtered = allData.filter(r =>
    Object.keys(f).every(k =>
      !f[k] || String(r[k]).toLowerCase().includes(f[k].toLowerCase())
    )
  );

  render(filtered);
}

function render(data) {
  tableBody.innerHTML = data.map(r => `
    <tr>
      <td>${r.voterId}</td>
      <td>${r.firstName}</td>
      <td>${r.lastName}</td>
      <td>${r.caste}</td>
      <td>${r.fatherName}</td>
      <td><button class="btn btn-sm btn-info" onclick='view(${JSON.stringify(r)})'>üëÅ</button></td>
    </tr>
  `).join('');
}

function view(r) {
  selected = r;
  details.innerHTML = `
    <div><b>Name:</b> ${r.firstName} ${r.lastName}</div>
    <div><b>Age:</b> ${r.age}</div>
    <div><b>DOB:</b> ${r.dob}</div>
    <div><b>Gender:</b> ${r.gender}</div>
    <div><b>Caste:</b> ${r.caste}</div>
    <div><b>Father:</b> ${r.fatherName}</div>
    <div><b>Door No:</b> ${r.doorNumber}</div>
  `;
  contactInput.value = r.contactNumber;

  new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function save() {
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({
      voterId: selected.voterId,
      contactNumber: contactInput.value
    })
  }).then(() => {
    alert("Contact updated");
    location.reload();
  });
}
</script>

</body>
</html>
